<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
    <script src="components/loader.js"></script>
    <script src="lib/onsenui/js/onsenui.min.js"></script>
    <link rel="stylesheet" href="components/loader.css">
    <link rel="stylesheet" href="lib/onsenui/css/onsenui.css">
    <link rel="stylesheet" href="lib/onsenui/css/onsen-css-components.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="keys.js"></script>
    <script>
        // アナログ時計の描画用関数↓
        function rgbToColor(r, g, b) {
            return "#" + hex02(r) + hex02(g) + hex02(b);
        }

        function hex02(x) {
            var str = "0" + x.toString(16);
            return str.substring(str.length - 2);
        }

        function decS2(x) {
            if (x < 10) {
                return "&nbsp;" + x.toString(10);
            } else {
                return x.toString(10);
            }
        }

        function dec02(x) {
            var str = "0" + x.toString(10);
            return str.substring(str.length - 2);
        }

        var debug = false;
        // Statusがクリックされた時の処理
        function setDebugMode(e) {
            debug = !debug;
            $("#status").html("Debug Mode: " + debug);
        }

        // 座標計算
        // getX(中心x座標,角度(1で一周),長さ(1で最大)
        function getX(cx, d, r) {
            return cx + Math.sin(d * 2 * 3.14) * cx * r;
        }
        // getY(中心y座標,角度(1で一周),長さ(1で最大)
        function getY(cy, d, r) {
            return cy - Math.cos(d * 2 * 3.14) * cy * r;
        }
        // 線の描画
        // line(context,x1,y1,x2,y2,線の太さ,色)
        function line(ctx, x1, y1, x2, y2, width, color) {
            ctx.lineWidth = width;
            ctx.lineCap = "round";
            ctx.strokeStyle = color;
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
        }
        // アナログ時計の表示(時, 分, 秒)
        function showAnalogClock(hour, minute, second, hide=false) {
            var canvas = $('#mycanvas')[0];
            var ctx = canvas.getContext('2d');
            ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            var cx = canvas.width / 2;
            var cy = canvas.height / 2;
            var ds = second / 60;
            var dm = (minute + ds) / 60;
            var dh = (hour % 12 + dm) / 12;

            for (var i = 0; i < 60; i++) {
                var px = getX(cx, i / 60, 0.9);
                var py = getY(cy, i / 60, 0.9);
                ctx.fillStyle = 'rgb(0, 255, 0)';
                ctx.beginPath();
                ctx.arc(px, py, 2, 0, Math.PI * 2, false);
                ctx.fill();
            }

            for (var i = 0; i < 12; i++) {
                var px = getX(cx, i / 12, 0.9);
                var py = getY(cy, i / 12, 0.9);
                ctx.fillStyle = 'rgb(255, 255, 0)';
                ctx.beginPath();
                ctx.arc(px, py, 5, 0, Math.PI * 2, false);
                ctx.fill();
            }

            if ((!hide) || hour > 0) {
                var px = getX(cx, dh, 0.4);
                var py = getY(cy, dh, 0.4);
                line(ctx, cx, cy, px, py, 20, 'rgb(255, 100, 162)')
            }
            if ((!hide) || hour > 0 || minute > 0) {
                var px = getX(cx, dm, 0.6);
                var py = getY(cy, dm, 0.6);
                line(ctx, cx, cy, px, py, 15, 'rgb(128, 255, 162)')
            }
            var px = getX(cx, ds, 0.9);
            var py = getY(cy, ds, 0.9);
            line(ctx, cx, cy, px, py, 5, 'rgb(128, 100, 255)')
        }
        // アナログ時計の描画用関数↑


        // プログラムの実行時の処理↓
        $(function() {
            init();
        });

        // 初期設定用関数
        function init() {
            $('#btnA').prop('disabled', false);
            $('#btnB').prop('disabled', false);
            $('#btnC').prop('disabled', false);

            // クリック時の処理の登録
            $(function() {
                $('#btnA').click(function(e) {
                    btnAClick(e);
                });

                $('#btnB').click(function(e) {
                    btnBClick(e);
                });

                $('#btnC').click(function(e) {
                    btnCClick(e);
                });
            });

            $("#hour").on(
                "input", function() {
                    OutOfBoundsPrevention();
                    displayDataInfo();
                }
            );
            $("#minute").on(
                "input", function() {
                    OutOfBoundsPrevention();
                    displayDataInfo();
                }
            );
            $("#second").on(
                "input", function() {
                    OutOfBoundsPrevention();
                    displayDataInfo();
                }
            );

            // 変数宣言
            var dateData;
            var year, month, date;
            var hour, minute, second;
            var timeDifference;
            var countryName = "";
            var canvas = $("#mycanvas")[0];
            var ctx = canvas.getContext("2d");

            // NCMBアクセスのための準備
            let ncmb = new NCMB(appKey, clientKey);
            // 利用するデータベースの指定（存在しなければ生成）
            let worldClock = ncmb.DataStore("WorldClock");

            // 時刻情報変更処理の登録
            $(function() {
                setInterval(function() {
                    reloadDate();
                }, 50);
            });
        }

        // Alarmの処理
        function alarm() {
            var img = new Image();
            img.src = "ksuisbg.gif";
            img.onload = function() {
                ctx.drawImage(img, 0, 0, 300, 300);
            };

            var audio = new Audio();
            audio.src = "pin.wav";
            audio.play();

            $("#btnA").prop("disabled", false);
        }

        // ButtonAがクリックされた時の処理
        function btnAClick(e) {
            
        }

        // ButtonBがクリックされた時の処理
        function btnBClick(e) {
            m += 100;
            $("#minute").prop("value", m);
            
            OutOfBoundsPrevention();
            displayDataInfo();
        }

        // ButtonCがクリックされた時の処理
        function btnCClick(e) {
            ctx.clearRect(0, 0, 300, 300);

            h = 0; m = 0; s = 0;
            rest = 0;
            $("#hour").prop("value", h);
            $("#minute").prop("value", m);
            $("#second").prop("value", s);

            OutOfBoundsPrevention();
            displayDataInfo();
        }

        // 繰り返し実行する処理
        function reloadDate() {
            dateData = new Date();
            timeDifference = 0;

            year = dateData.getFullYear();
            month = dateData.getMonth();
            date = dateData.getDate();
            hour = dateData.getHours() + timeDifference;
            minute = dateData.getMinutes();
            second = dateData.getSeconds();

            showAnalogClock(hour, minute, second);
        }

        function OutOfBoundsPrevention() {
            h = parseInt($("#hour").val());
            m = parseInt($("#minute").val());
            s = parseInt($("#second").val());

            period = parseInt(3600 * h + 60 * m + s);

            if (h<0) {
                h = 0;
            }
            if (m<0) {
                m = 0;
            } else if (m>=60) {
                h += parseInt(m/60);
                m -= 60*parseInt(m/60);
            }
            if (s<0) {
                s = 0;
            } else if (s>=60) {
                m += parseInt(s/60);
                s -= 60*parseInt(m/60);
            }

            $("#hour").prop("value", h);
            $("#minute").prop("value", m);
            $("#second").prop("value", s);
        }

        function displayDataInfo() {
            hstr = "";
            mstr = "";
            sstr = "";

            for (var i = 0; i < h; i++) {
                hstr += "○";
            }
            for (var i = 0; i < m; i++) {
                mstr += "○";
            }
            for (var i = 0; i < s; i++) {
                sstr += "○";
            }
            $("#hourStr").html(hstr);
            $("#minuteStr").html(mstr);
            $("#secondStr").html(sstr);

            $("#time").html("経過時間： " + time);
            $("#remain").html(
                "残り時間： " + h + "時間" + m + "分" + s + "秒"
            );
        }
    </script>
</head>

<body>
    <div id="clock">
        <canvas id="mycanvas" width="375" height="375">
            Test
        </canvas>
    </div>
    <div id="button">
        <button id="btnA" class="btn">Register</button>
        <button id="btnB" class="btn">Remove</button>
        <button id="btnC" class="btn">Show</button>
    </div>
    <div id="label">
        <div>
            <label for="name" class="lbl">
                Country(Region):
            </label>
            <input id="name" type="text" class="field"></label>
        </div>
        <div>
            <label for="timeDifference" class="lbl">
                Time Difference:
            </label>
            <input id="td" type="number" class="field"></label>
        </div>
        <div>
            <label for="info" class="lbl">
                Information (Log):
            </label><br>
            <label id="info" class="field"></label>
        </div>
    </div>
</body>

</html>